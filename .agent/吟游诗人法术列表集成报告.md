# 吟游诗人法术列表集成报告

## 完成的工作

### 1. 类型系统更新
- ✅ 在 `types.ts` 中的 `ClassItem` 接口添加了 `spellList?: string` 字段
- ✅ 允许职业标记其法术列表类别，用于后续的法术过滤

### 2. 吟游诗人数据更新
- ✅ 在 `data/classes/bard.ts` 中添加了 `spellList: "吟游诗人"` 字段
- ✅ 吟游诗人职业现在正式关联到"吟游诗人"法术列表

### 3. 法术数据库验证
已验证法术数据库中存在大量吟游诗人法术，包括：

**戏法 (Cantrips)**：
- 剑刃防护 (Blade Ward)
- 舞光术 (Dancing Lights)
- 交友术 (Friends)
- 光亮术 (Light)
- 法师之手 (Mage Hand)
- 修复术 (Mending)
- 传讯术 (Message)
- 次级幻象 (Minor Illusion)
- 魔法伎俩 (Prestidigitation)
- 点点星芒 (Starry Wisp)
- 鸣雷破 (Thunderclap)
- 克敌先击 (True Strike)
- 恶言相加 (Vicious Mockery) - **吟游诗人专属**

**1-9环法术**：
法术数据库已包含所有环位的吟游诗人法术，都正确标记了 `classes: ["吟游诗人", ...]`

## 现有系统能力

### 法术过滤机制
`StepSpells.tsx` 组件已经实现了基于职业的法术过滤：

```typescript
// 第41-55行
const spellListClasses = useMemo(() => {
    if (character.originFeat?.includes('魔法学徒')) {
        // 首先检查背景是否锁定了法术列表
        if (selectedBackground?.featSpellList) {
            return [selectedBackground.featSpellList];
        }
        // 然后检查用户选择的法术列表
        if (featConfig.spellList) {
            return [featConfig.spellList];
        }
        // 如果都没有，允许所有三个法术列表（需要用户选择）
        return ['牧师', '德鲁伊', '法师'];
    }
    return [];
}, [character.originFeat, selectedBackground?.featSpellList, featConfig.spellList]);

// 第58-71行 - 过滤戏法
const availableCantrips = useMemo(() => {
    let cantrips = SPELL_DB.filter(s => s.level === 0);
    if (spellListClasses.length > 0) {
        cantrips = cantrips.filter(s =>
            s.classes?.some((c: string) => spellListClasses.includes(c))
        );
    }
    // ...
}, [spellListClasses, cantripSearch]);
```

## 下一步工作

### 需要实现的功能

1. **扩展法术选择到职业施法**
   - 目前 `StepSpells.tsx` 只处理专长授予的法术
   - 需要扩展以支持吟游诗人职业的法术选择
   - 根据吟游诗人等级显示可选法术

2. **实现准备法术系统**
   - 吟游诗人需要准备法术，数量随等级增长
   - 1级：准备4个法术（推荐：七彩喷射、不谐低语、治愈真言）
   - 戏法：2个（推荐：舞光术、恶言相加）

3. **魔法奥秘 (Magical Secrets) 特性**
   - 10级吟游诗人可以从任何职业法术列表中选择法术
   - 需要实现打破法术列表限制的机制

4. **子职业特性支持**
   - 学识吟游诗人 (Lore Bard) 的额外法术奥秘
   - 需要在法术选择时考虑子职业特性

### 建议的实现步骤

#### 步骤 1: 创建职业法术选择组件
创建或修改组件以支持职业法术选择（不仅是专长）：
- 检测角色是否有施法职业（吟游诗人、法师等）
- 根据职业的 `spellList` 字段过滤可用法术
- 显示准备法术的界面

#### 步骤 2: 实现等级相关的法术访问
- 根据角色等级限制可访问的法术环位
- 显示法术位数量（从 `classTable` 获取）
- 显示可准备法术数量

#### 步骤 3: 实现特殊能力覆盖
添加逻辑来检查是否有特性打破法术列表限制：

```typescript
// 伪代码示例
const canAccessAllSpells = useMemo(() => {
    // 检查是否有"魔法奥秘"特性
    const hasMagicalSecrets = character.features?.some(
        f => f.name.includes('魔法奥秘')
    );
    
    // 检查子职业特殊能力
    const hasSubclassOverride = /* ... */;
    
    return hasMagicalSecrets || hasSubclassOverride;
}, [character]);

// 在法术过滤时使用
if (canAccessAllSpells) {
    // 允许选择所有法术
} else {
    // 限制在职业法术列表
}
```

#### 步骤 4: UI 更新
- 在法术列表中显示法术的职业标签
- 高亮显示通过特殊能力获得的法术
- 显示法术的特殊属性（专注 C、仪式 R、材料 M）

## 数据完整性

✅ 吟游诗人的 `classTable` 已完整，包含：
   - 准备法术数量（每级）
   - 法术位（1-9环）
   - 诗人骰进展

✅ 法术数据库完整，所有法术都正确标记了职业

✅ 类型系统已更新，支持法术列表引用

## 注意事项

### 特殊法术属性
法术数据中应包含的特殊标记（如果需要显示）：
- **C** = Concentration（专注）
- **R** = Ritual（仪式）
- **M** = Material（材料）

建议在 `SpellItem` 类型中添加这些字段（如果还没有）：
```typescript
export interface SpellItem {
    // ... 现有字段 ...
    requiresConcentration?: boolean;
    ritual?: boolean;
    materialComponent?: string; // 已作为 components 的一部分
}
```

### 性能考虑
- 法术列表可能很长，建议实现虚拟滚动或分页
- 搜索和过滤应该使用 `useMemo` 优化
- 考虑将法术数据分级加载（按等级）

## 总结

基础设施已就绪：
1. ✅ 类型系统支持法术列表
2. ✅ 吟游诗人数据已配置
3. ✅ 法术数据库完整
4. ✅ 现有过滤机制可复用

下一步需要将专长法术选择的机制扩展到职业施法，并实现吟游诗人的准备法术系统。
